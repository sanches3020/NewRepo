@model Sofia.Web.Models.Note
@{
    ViewData["Title"] = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫—É";
}

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫—É</h4>
            </div>
            <div class="card-body">
                <form id="noteForm">
                    <input asp-for="Id" type="hidden" id="noteId" />
                    <input asp-for="CreatedAt" type="hidden" />
                    
                    <div class="mb-3">
                        <label asp-for="Content" class="form-label">–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏ *</label>
                        <textarea asp-for="Content" class="form-control" id="content" name="content" rows="6" placeholder="–û–ø–∏—à–∏—Ç–µ —Å–≤–æ–∏ –º—ã—Å–ª–∏, —á—É–≤—Å—Ç–≤–∞, —Å–æ–±—ã—Ç–∏—è –¥–Ω—è..." required></textarea>
                        <span asp-validation-for="Content" class="text-danger"></span>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="Emotion" class="form-label">–≠–º–æ—Ü–∏—è</label>
                                <select class="form-select" id="emotion" name="emotion">
                                    @{
                                        var currentEmotion = Model.Emotion.ToString();
                                    }
                                    <option value="VerySad" selected="@(currentEmotion == "VerySad")">üò¢ –û—á–µ–Ω—å –≥—Ä—É—Å—Ç–Ω–æ</option>
                                    <option value="Sad" selected="@(currentEmotion == "Sad")">üòî –ì—Ä—É—Å—Ç–Ω–æ</option>
                                    <option value="Neutral" selected="@(currentEmotion == "Neutral")">üòê –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ</option>
                                    <option value="Happy" selected="@(currentEmotion == "Happy")">üòä –†–∞–¥–æ—Å—Ç–Ω–æ</option>
                                    <option value="VeryHappy" selected="@(currentEmotion == "VeryHappy")">üòÑ –û—á–µ–Ω—å —Ä–∞–¥–æ—Å—Ç–Ω–æ</option>
                                    <option value="Anxious" selected="@(currentEmotion == "Anxious")">üò∞ –¢—Ä–µ–≤–æ–∂–Ω–æ</option>
                                    <option value="Calm" selected="@(currentEmotion == "Calm")">üòå –°–ø–æ–∫–æ–π–Ω–æ</option>
                                    <option value="Excited" selected="@(currentEmotion == "Excited")">ü§© –í–∑–≤–æ–ª–Ω–æ–≤–∞–Ω–Ω–æ</option>
                                    <option value="Frustrated" selected="@(currentEmotion == "Frustrated")">üò§ –†–∞–∑–¥—Ä–∞–∂—ë–Ω–Ω–æ</option>
                                    <option value="Grateful" selected="@(currentEmotion == "Grateful")">üôè –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="Activity" class="form-label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</label>
                                <input asp-for="Activity" class="form-control" id="activity" name="activity" placeholder="–†–∞–±–æ—Ç–∞, —É—á—ë–±–∞, –æ—Ç–¥—ã—Ö, —Å–ø–æ—Ä—Ç..." />
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Tags" class="form-label">–¢–µ–≥–∏</label>
                        <input asp-for="Tags" class="form-control" id="tags" name="tags" placeholder="—Ç—Ä–µ–≤–æ–≥–∞, —Ä–∞–±–æ—Ç–∞, —Å–µ–º—å—è (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" />
                        <div class="form-text">–¢–µ–≥–∏ –ø–æ–º–æ–≥—É—Ç –Ω–∞–π—Ç–∏ –∑–∞–º–µ—Ç–∫–∏ –ø–æ —Ç–µ–º–∞–º</div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Date" class="form-label">–î–∞—Ç–∞</label>
                        <input asp-for="Date" type="date" class="form-control" id="date" name="date" value="@Model.Date.ToString("yyyy-MM-dd")" />
                        <div id="dateHint" class="form-text mt-1">–î–∞—Ç–∞: @Model.Date.ToString("dd.MM.yyyy")</div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input asp-for="IsPinned" class="form-check-input" id="isPinned" name="isPinned" />
                            <label asp-for="IsPinned" class="form-check-label">
                                üìå –ó–∞–∫—Ä–µ–ø–∏—Ç—å –∑–∞–º–µ—Ç–∫—É
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input asp-for="ShareWithPsychologist" class="form-check-input" id="shareWithPsychologist" name="shareWithPsychologist" />
                            <label asp-for="ShareWithPsychologist" class="form-check-label">
                                üë• –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –ø—Å–∏—Ö–æ–ª–æ–≥–æ–º
                            </label>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="/notes" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
                        <button type="button" class="btn btn-primary" onclick="saveNote()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function saveNote() {
    const form = document.getElementById('noteForm');
    const formData = new FormData(form);
    const noteId = document.getElementById('noteId').value;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
    if (!formData.get('content') || !formData.get('emotion')) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
        return;
    }

    // Validate date and possibly confirm when too far
    const dateStr = formData.get('date');
    const dateCheck = evaluateDate(dateStr);
    if (dateCheck.level === 'red') {
        if (!confirm('–í—ã –≤—ã–±—Ä–∞–ª–∏ –æ—á–µ–Ω—å –¥–∞–ª—ë–∫—É—é –¥–∞—Ç—É. –£–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–º–µ—Ç–∫—É?')) {
            return;
        }
    }

    const data = {
        content: formData.get('content'),
        tags: formData.get('tags'),
        emotion: formData.get('emotion'),
        activity: formData.get('activity'),
        date: formData.get('date'),
        isPinned: formData.get('isPinned') === 'on',
        shareWithPsychologist: formData.get('shareWithPsychologist') === 'on'
    };

    fetch('/notes/edit/' + noteId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert(result.message);
            window.location.href = '/notes';
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
    });
}

// Date evaluation helpers
function evaluateDate(dateStr) {
    const today = new Date();
    let d = dateStr ? new Date(dateStr) : today;
    if (isNaN(d)) d = today;
    const diffMs = Math.abs(today - d);
    const diffYears = diffMs / (1000 * 60 * 60 * 24 * 365);

    if (diffYears <= 1) {
        return { level: 'green', message: '–î–∞—Ç–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –≥–æ–¥–∞ ‚Äî —Ö–æ—Ä–æ—à–∞—è –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–ø–∏—Å—å', color: '#16a34a' };
    }
    if (diffYears <= 5) {
        return { level: 'yellow', message: '–î–∞—Ç–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 1‚Äì5 –ª–µ—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, –∞–∫—Ç—É–∞–ª—å–Ω–∞ –ª–∏ –∑–∞–ø–∏—Å—å', color: '#f59e0b' };
    }
    return { level: 'red', message: '–í—ã –≤—ã–±—Ä–∞–ª–∏ –æ—á–µ–Ω—å –¥–∞–ª—ë–∫—É—é –¥–∞—Ç—É ‚Äî —ç—Ç–æ –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è', color: '#ef4444' };
}

function updateDateHint(dateStr) {
    const hint = document.getElementById('dateHint');
    if (!hint) return;
    const res = evaluateDate(dateStr);
    hint.textContent = res.message;
    hint.style.color = res.color;
}

// Hook date input change
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('date');
    if (dateInput) {
        updateDateHint(dateInput.value);
        dateInput.addEventListener('change', function() {
            updateDateHint(this.value);
        });
    }
});
</script>
