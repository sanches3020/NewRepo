@{
    ViewData["Title"] = "–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞";
    var targetDate = ViewBag.TargetDate as DateTime? ?? DateTime.Today;
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üìù –ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞</h2>
    <a href="/notes" class="btn btn-outline-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ –∑–∞–º–µ—Ç–∫–∞–º</a>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">‚úçÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏</h5>
            </div>
            <div class="card-body">
                <form id="noteForm">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="content" class="form-label">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏ *</label>
                            <textarea class="form-control" id="content" name="content" rows="6" 
                                      placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ, –∫–∞–∫ –≤—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—Ç–µ, –æ —á–µ–º –¥—É–º–∞–µ—Ç–µ..." required></textarea>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="emotion" class="form-label">–≠–º–æ—Ü–∏—è *</label>
                            <select class="form-select" id="emotion" name="emotion" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ—Ü–∏—é</option>
                                <option value="VerySad">üò¢ –û—á–µ–Ω—å –≥—Ä—É—Å—Ç–Ω–æ</option>
                                <option value="Sad">üòî –ì—Ä—É—Å—Ç–Ω–æ</option>
                                <option value="Neutral">üòê –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ</option>
                                <option value="Happy">üòä –†–∞–¥–æ—Å—Ç–Ω–æ</option>
                                <option value="VeryHappy">üòÑ –û—á–µ–Ω—å —Ä–∞–¥–æ—Å—Ç–Ω–æ</option>
                                <option value="Anxious">üò∞ –¢—Ä–µ–≤–æ–∂–Ω–æ</option>
                                <option value="Calm">üòå –°–ø–æ–∫–æ–π–Ω–æ</option>
                                <option value="Excited">ü§© –í–∑–≤–æ–ª–Ω–æ–≤–∞–Ω–Ω–æ</option>
                                <option value="Frustrated">üò§ –†–∞–∑–¥—Ä–∞–∂—ë–Ω–Ω–æ</option>
                                <option value="Grateful">üôè –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="date" class="form-label">–î–∞—Ç–∞</label>
                            <input type="date" class="form-control" id="date" name="date" value="@targetDate.ToString("yyyy-MM-dd")">
                        </div>
                        
                        <div class="col-md-6">
                            <label for="tags" class="form-label">–¢–µ–≥–∏</label>
                            <input type="text" class="form-control" id="tags" name="tags" 
                                   placeholder="—Ä–∞–±–æ—Ç–∞, —Å–µ–º—å—è, –∑–¥–æ—Ä–æ–≤—å–µ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)">
                            <small class="form-text text-muted">–†–∞–∑–¥–µ–ª—è–π—Ç–µ —Ç–µ–≥–∏ –∑–∞–ø—è—Ç—ã–º–∏</small>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="activity" class="form-label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</label>
                            <input type="text" class="form-control" id="activity" name="activity" 
                                   placeholder="–ø—Ä–æ–≥—É–ª–∫–∞, —Ä–∞–±–æ—Ç–∞, —á—Ç–µ–Ω–∏–µ">
                        </div>
                        
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isPinned" name="isPinned">
                                <label class="form-check-label" for="isPinned">
                                    üìå –ó–∞–∫—Ä–µ–ø–∏—Ç—å –∑–∞–º–µ—Ç–∫—É
                                </label>
                                <small class="form-text text-muted d-block">–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤–≤–µ—Ä—Ö—É —Å–ø–∏—Å–∫–∞</small>
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="shareWithPsychologist" name="shareWithPsychologist">
                                <label class="form-check-label" for="shareWithPsychologist">
                                    üë®‚Äç‚öïÔ∏è –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –ø—Å–∏—Ö–æ–ª–æ–≥–æ–º
                                </label>
                                <small class="form-text text-muted d-block">–ü–æ–∑–≤–æ–ª—è–µ—Ç –ø—Å–∏—Ö–æ–ª–æ–≥—É –≤–∏–¥–µ—Ç—å —ç—Ç—É –∑–∞–º–µ—Ç–∫—É</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button type="button" class="btn btn-primary" onclick="saveNote()">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–º–µ—Ç–∫—É
                        </button>
                        <button type="button" class="btn btn-outline-secondary ms-2" onclick="resetForm()">
                            üîÑ –û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                        <a href="/notes" class="btn btn-outline-danger ms-2">‚ùå –û—Ç–º–µ–Ω–∞</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">üí° –°–æ–≤–µ—Ç—ã</h6>
            </div>
            <div class="card-body">
                <div class="tips">
                    <div class="tip-item mb-3">
                        <h6 class="text-primary">üìù –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</h6>
                        <p class="small text-muted mb-0">–û–ø–∏—à–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è –¥–Ω—è, —Å–≤–æ–∏ –º—ã—Å–ª–∏ –∏ —á—É–≤—Å—Ç–≤–∞. –ù–µ –±–æ–π—Ç–µ—Å—å –±—ã—Ç—å —á–µ—Å—Ç–Ω—ã–º–∏.</p>
                    </div>
                    <div class="tip-item mb-3">
                        <h6 class="text-success">üòä –≠–º–æ—Ü–∏–∏</h6>
                        <p class="small text-muted mb-0">–í—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –ª—É—á—à–µ –≤—Å–µ–≥–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –≤–∞—à–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.</p>
                    </div>
                    <div class="tip-item mb-3">
                        <h6 class="text-info">üè∑Ô∏è –¢–µ–≥–∏</h6>
                        <p class="small text-muted mb-0">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–≥–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏ –∑–∞–º–µ—Ç–æ–∫: —Ä–∞–±–æ—Ç–∞, —Å–µ–º—å—è, –∑–¥–æ—Ä–æ–≤—å–µ.</p>
                    </div>
                    <div class="tip-item">
                        <h6 class="text-warning">üìå –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ</h6>
                        <p class="small text-muted mb-0">–ó–∞–∫—Ä–µ–ø–ª—è–π—Ç–µ –≤–∞–∂–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏, —á—Ç–æ–±—ã –æ–Ω–∏ –≤—Å–µ–≥–¥–∞ –±—ã–ª–∏ –Ω–∞ –≤–∏–¥—É.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h6>
            </div>
            <div class="card-body">
                <div class="stats">
                    <div class="stat-item d-flex justify-content-between mb-2">
                        <span>–ó–∞–º–µ—Ç–æ–∫ —Å–µ–≥–æ–¥–Ω—è:</span>
                        <span class="text-primary" id="todayNotes">0</span>
                    </div>
                    <div class="stat-item d-flex justify-content-between mb-2">
                        <span>–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö:</span>
                        <span class="text-warning" id="pinnedNotes">0</span>
                    </div>
                    <div class="stat-item d-flex justify-content-between">
                        <span>–î–ª—è –ø—Å–∏—Ö–æ–ª–æ–≥–∞:</span>
                        <span class="text-info" id="sharedNotes">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.tips {
    space-y: 15px;
}

.tip-item {
    padding: 10px 0;
    border-bottom: 1px solid #f3f4f6;
}

.tip-item:last-child {
    border-bottom: none;
}

.stats .stat-item {
    padding: 5px 0;
}

.card {
    transition: transform 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
}

.form-control:focus, .form-select:focus {
    border-color: #6b7cff;
    box-shadow: 0 0 0 0.2rem rgba(107, 124, 255, 0.25);
}
</style>

<script>
function saveNote() {
    const form = document.getElementById('noteForm');
    const formData = new FormData(form);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
    if (!formData.get('content') || !formData.get('emotion')) {
        showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
        return;
    }
    
    const data = {
        content: formData.get('content'),
        tags: formData.get('tags'),
        emotion: formData.get('emotion'),
        activity: formData.get('activity'),
        date: formData.get('date'),
        isPinned: formData.get('isPinned') === 'on',
        shareWithPsychologist: formData.get('shareWithPsychologist') === 'on'
    };
    
    fetch('/notes/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast(result.message, 'success');
            setTimeout(() => {
                window.location.href = '/notes';
            }, 1000);
        } else {
            showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + result.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
    });
}

function resetForm() {
    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã?')) {
        document.getElementById('noteForm').reset();
        showToast('–§–æ—Ä–º–∞ –æ—á–∏—â–µ–Ω–∞', 'info');
    }
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.textContent = message;
    
    const colors = {
        success: '#10b981',
        error: '#ef4444',
        info: '#3b82f6',
        warning: '#f59e0b'
    };
    
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type]};
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        z-index: 1000;
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
document.addEventListener('DOMContentLoaded', function() {
    fetch('/notes/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('todayNotes').textContent = data.todayNotes || 0;
                document.getElementById('pinnedNotes').textContent = data.pinnedNotes || 0;
                document.getElementById('sharedNotes').textContent = data.sharedNotes || 0;
            }
        })
        .catch(error => {
            console.error('Error loading stats:', error);
        });
});
</script>