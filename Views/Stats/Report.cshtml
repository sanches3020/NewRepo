@{
    ViewData["Title"] = "–û—Ç—á–µ—Ç";
    dynamic reportData = ViewBag.ReportData;
    string format = ViewBag.Format as string;
}

@if (format == "pdf")
{
    <style>
        body { font-family: Arial, sans-serif; }
        .report-header { text-align: center; margin-bottom: 30px; }
        .report-section { margin-bottom: 25px; }
        .chart-placeholder { background: #f8f9fa; padding: 20px; text-align: center; border: 1px solid #dee2e6; }
        .no-print { display: none; }
    </style>
}

<div class="d-flex justify-content-between align-items-center mb-4 no-print">
    <h2>üìä –û—Ç—á–µ—Ç –ø–æ –¥–∞–Ω–Ω—ã–º</h2>
    <div class="d-flex gap-2">
        <a href="/stats" class="btn btn-outline-secondary">‚Üê –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
        <button class="btn btn-outline-primary" onclick="window.print()">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
        <a href="/stats/report?days=@reportData.Period.Days&format=json" class="btn btn-outline-success">üì• JSON</a>
    </div>
</div>

<div class="report-header">
    <h1>Sofia ‚Äî –û—Ç—á–µ—Ç –æ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–∏</h1>
    <p class="text-muted">
        –ü–µ—Ä–∏–æ–¥: @reportData.Period.Start.ToString("dd.MM.yyyy") ‚Äî
        @reportData.Period.End.ToString("dd.MM.yyyy")
        (@reportData.Period.Days –¥–Ω–µ–π)
    </p>
    <p class="text-muted">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: @reportData.GeneratedAt.ToString("dd.MM.yyyy HH:mm")</p>
</div>

<!-- Summary -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="h3 text-primary">@reportData.Summary.TotalNotes</div>
                <div class="text-muted">–ó–∞–º–µ—Ç–æ–∫</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="h3 text-success">@reportData.Summary.CompletedGoals</div>
                <div class="text-muted">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —Ü–µ–ª–µ–π</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="h3 text-info">@reportData.Summary.ActiveGoals</div>
                <div class="text-muted">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ü–µ–ª–µ–π</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="h3 text-warning">@reportData.Summary.AverageMood.ToString("F1")</div>
                <div class="text-muted">–°—Ä–µ–¥–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div>
            </div>
        </div>
    </div>
</div>

<!-- Emotion Analysis -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">üé≠ –ê–Ω–∞–ª–∏–∑ —ç–º–æ—Ü–∏–π</h5>
    </div>
    <div class="card-body">
        @if (((IEnumerable<dynamic>)reportData.EmotionStats).Any())
        {
            <div class="row">
                <div class="col-md-8">
                    @foreach (var emotion in reportData.EmotionStats)
                    {
                        double percentage = reportData.Summary.TotalNotes > 0
                            ? (emotion.Count / (double)reportData.Summary.TotalNotes) * 100
                            : 0;

                        <div class="emotion-bar mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <div class="d-flex align-items-center">
                                    <div class="emotion-legend-color me-2" style="background-color:@GetEmotionColor(emotion.Emotion)"></div>
                                    <span class="small">@GetEmotionEmoji(emotion.Emotion) @GetEmotionName(emotion.Emotion)</span>
                                </div>
                                <span class="small text-muted">@emotion.Count (@percentage.ToString("F1")%)</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar"
                                     style="width:@percentage%; background-color:@GetEmotionColor(emotion.Emotion)">
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div class="col-md-4">
                    <div class="chart-placeholder">
                        <h6>üìà –ì—Ä–∞—Ñ–∏–∫ —ç–º–æ—Ü–∏–π</h6>
                        <p class="text-muted">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —ç–º–æ—Ü–∏–π –∑–∞ –ø–µ—Ä–∏–æ–¥</p>

                        @if (reportData.Summary.MostFrequentEmotion != null)
                        {
                            <div class="alert alert-info">
                                <strong>–°–∞–º–∞—è —á–∞—Å—Ç–∞—è —ç–º–æ—Ü–∏—è:</strong><br>
                                @GetEmotionEmoji(reportData.Summary.MostFrequentEmotion)
                                @GetEmotionName(reportData.Summary.MostFrequentEmotion)
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="text-center text-muted py-4">
                <div style="font-size:48px;">üìä</div>
                <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± —ç–º–æ—Ü–∏—è—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>
            </div>
        }
    </div>
</div>

<!-- Activity -->
@if (((IEnumerable<dynamic>)reportData.ActivityStats).Any())
{
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">üèÉ –ê–Ω–∞–ª–∏–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>–¢–æ–ø –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π:</h6>
                    @foreach (var activity in reportData.ActivityStats.Take(5))
                    {
                        <div class="d-flex justify-content-between mb-2">
                            <span>üèÉ @activity.Activity</span>
                            <span class="badge bg-primary">@activity.Count</span>
                        </div>
                    }
                </div>
                <div class="col-md-6">
                    @if (reportData.Summary.MostFrequentActivity != null)
                    {
                        <div class="alert alert-success">
                            <h6 class="alert-heading">‚≠ê –°–∞–º–∞—è —á–∞—Å—Ç–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h6>
                            <p>@reportData.Summary.MostFrequentActivity</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

<!-- Goals -->
@if (((IEnumerable<dynamic>)reportData.Goals).Any())
{
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">üéØ –ê–Ω–∞–ª–∏–∑ —Ü–µ–ª–µ–π</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3 text-center">
                    <div class="h4 text-primary">@reportData.GoalStats.Total</div>
                    <div class="text-muted">–í—Å–µ–≥–æ —Ü–µ–ª–µ–π</div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="h4 text-success">@reportData.GoalStats.Completed</div>
                    <div class="text-muted">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="h4 text-info">@reportData.GoalStats.Active</div>
                    <div class="text-muted">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="h4 text-warning">@reportData.GoalStats.AverageProgress.ToString("F0")%</div>
                    <div class="text-muted">–°—Ä–µ–¥–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å</div>
                </div>
            </div>

            <div class="mt-4">
                <h6>–ê–∫—Ç–∏–≤–Ω—ã–µ —Ü–µ–ª–∏:</h6>
                <div class="row g-2">
                    @foreach (var goal in ((IEnumerable<dynamic>)reportData.Goals)
                        .Where(g => g.Status == Sofia.Web.Models.GoalStatus.Active)
                        .Take(6))
                    {
                        <div class="col-md-6">
                            <div class="goal-item p-3 border rounded">
                                <div class="d-flex justify-content-between mb-2">
                                    <h6 class="mb-0">@goal.Title</h6>
                                    <span class="badge bg-primary">@goal.Progress%</span>
                                </div>
                                <div class="progress" style="height:4px;">
                                    <div class="progress-bar bg-primary" style="width:@goal.Progress%"></div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

<!-- Mood Trends -->
@if (((IEnumerable<dynamic>)reportData.MoodTrends).
