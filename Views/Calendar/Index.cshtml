@{
    ViewData["Title"] = "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å";
    var currentMonth = (DateTime)ViewBag.CurrentMonth;
    var previousMonth = (DateTime)ViewBag.PreviousMonth;
    var nextMonth = (DateTime)ViewBag.NextMonth;
    var calendarData = ViewBag.CalendarData as Dictionary<DateTime, List<Sofia.Web.Models.Note>>;
    var emotionData = ViewBag.EmotionData as Dictionary<DateTime, List<Sofia.Web.Models.EmotionEntry>>;
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üìÖ –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å</h2>
    <div class="d-flex gap-2">
        <a href="/calendar/emotion-stats" class="btn btn-outline-info btn-sm">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
        <a href="/notes/create" class="btn btn-primary btn-sm">+ –ó–∞–º–µ—Ç–∫–∞</a>
    </div>
</div>

<!-- Month Navigation -->
<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
            <a href="/calendar?year=@previousMonth.Year&month=@previousMonth.Month" class="btn btn-outline-secondary">
                ‚Üê @previousMonth.ToString("MMMM yyyy")
            </a>
            <h4 class="mb-0">@currentMonth.ToString("MMMM yyyy")</h4>
            <a href="/calendar?year=@nextMonth.Year&month=@nextMonth.Month" class="btn btn-outline-secondary">
                @nextMonth.ToString("MMMM yyyy") ‚Üí
            </a>
        </div>
    </div>
</div>

<!-- Calendar Grid -->
<div class="card">
    <div class="card-body p-0">
        <div class="calendar-grid">
            <!-- Weekday Headers -->
            <div class="calendar-header">
                <div class="calendar-day-header">–ü–Ω</div>
                <div class="calendar-day-header">–í—Ç</div>
                <div class="calendar-day-header">–°—Ä</div>
                <div class="calendar-day-header">–ß—Ç</div>
                <div class="calendar-day-header">–ü—Ç</div>
                <div class="calendar-day-header">–°–±</div>
                <div class="calendar-day-header">–í—Å</div>
            </div>

            <!-- Calendar Days -->
            @{
                var startDate = currentMonth.AddDays(-(int)currentMonth.DayOfWeek);
                if (currentMonth.DayOfWeek == DayOfWeek.Sunday) startDate = startDate.AddDays(-6);
                else startDate = startDate.AddDays(1);
            }

            @for (int week = 0; week < 6; week++)
            {
                <div class="calendar-week">
                    @for (int day = 0; day < 7; day++)
                    {
                        var date = startDate.AddDays(week * 7 + day);
                        var dayNotes = calendarData?.ContainsKey(date) == true ? calendarData[date] : new List<Sofia.Web.Models.Note>();
                        var dayEmotions = emotionData?.ContainsKey(date) == true ? emotionData[date] : new List<Sofia.Web.Models.EmotionEntry>();
                        var isCurrentMonth = date.Month == currentMonth.Month;
                        var isToday = date.Date == DateTime.Today;
                        var dominantEmotion = GetDominantEmotion(dayEmotions);

                        <div class="calendar-day @(isCurrentMonth ? "" : "other-month") @(isToday ? "today" : "")"
                              data-date="@date.ToString("yyyy-MM-dd")"
                              style="background-color: @GetEmotionColor(dominantEmotion)"
                              onclick="openDayDetails('@date.ToString("yyyy-MM-dd")', @(dayNotes.Count + dayEmotions.Count))">
                            <div class="calendar-day-number">@date.Day</div>
                            @if (dayEmotions.Any())
                            {
                                <div class="calendar-day-emotions">
                                    @foreach (var emotion in dayEmotions.Take(3))
                                    {
                                        <span class="emotion-dot" title="@GetEmotionName(emotion.Emotion)">@GetEmotionEmoji(emotion.Emotion)</span>
                                    }
                                    @if (dayEmotions.Count > 3)
                                    {
                                        <span class="emotion-count">+@(dayEmotions.Count - 3)</span>
                                    }
                                </div>
                            }
                            @if (isToday && !dayEmotions.Any() && !dayNotes.Any())
                            {
                                <div class="calendar-day-hint">üí≠</div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

<!-- Day Details Modal -->
<div class="modal fade" id="dayDetailsModal" tabindex="-1" aria-labelledby="dayDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dayDetailsModalLabel">–î–µ—Ç–∞–ª–∏ –¥–Ω—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="dayDetailsContent">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                <a href="#" id="createNoteBtn" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –∑–∞–º–µ—Ç–∫—É</a>
            </div>
        </div>
    </div>
</div>

@* –£–±—Ä–∞–ª–∏ –ª–µ–≥–µ–Ω–¥—É —ç–º–æ—Ü–∏–π *@

<style>
.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
}

.calendar-header {
    display: contents;
}

.calendar-day-header {
    background: #f9fafb;
    padding: 12px 8px;
    text-align: center;
    font-weight: 600;
    color: #6b7280;
    font-size: 0.875rem;
}

.calendar-week {
    display: contents;
}

.calendar-day {
    background: #ffffff;
    min-height: 80px;
    padding: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid transparent;
    position: relative;
}

.calendar-day:hover {
    border-color: #6b7cff;
    transform: scale(1.02);
    z-index: 10;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.calendar-day.other-month {
    background: #f9fafb;
    color: #9ca3af;
}

.calendar-day.today {
    border-color: #ef4444;
    font-weight: bold;
}

.calendar-day-number {
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 4px;
}

.calendar-day-emotions {
    display: flex;
    flex-wrap: wrap;
    gap: 2px;
}

.emotion-dot {
    font-size: 0.75rem;
    line-height: 1;
}

.emotion-count {
    font-size: 0.625rem;
    color: #6b7280;
    font-weight: 500;
}

.emotion-legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
    border: 1px solid rgba(0,0,0,0.1);
}
</style>

<!-- Emotion Selection Modal -->
<div class="modal fade" id="emotionModal" tabindex="-1" aria-labelledby="emotionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="emotionModalLabel">–í—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ—Ü–∏—é</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <small>üí° –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å –¥–æ 5 —ç–º–æ—Ü–∏–π –≤ –¥–µ–Ω—å. –ö–∞–∂–¥–∞—è —ç–º–æ—Ü–∏—è –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Å–≤–æ—é –∑–∞–º–µ—Ç–∫—É.</small>
                </div>
                <div class="row g-2">
                    @foreach (var emotion in Enum.GetValues<Sofia.Web.Models.EmotionType>())
                    {
                        <div class="col-6 col-md-4">
                            <button type="button" class="btn btn-outline-secondary w-100 emotion-btn" 
                                    data-emotion="@emotion" 
                                    data-emotion-name="@GetEmotionName(emotion)"
                                    data-emotion-emoji="@GetEmotionEmoji(emotion)">
                                <span class="me-2">@GetEmotionEmoji(emotion)</span>
                                @GetEmotionName(emotion)
                            </button>
                        </div>
                    }
                </div>
                <div class="mt-3">
                    <label for="emotionNote" class="form-label">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É –∫ —ç–º–æ—Ü–∏–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <textarea class="form-control" id="emotionNote" rows="3" placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="saveEmotion">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç–º–æ—Ü–∏—é</button>
            </div>
        </div>
    </div>
</div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
window.selectedDate = null;
window.selectedEmotion = null;

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π fetch-—Ö–µ–ª–ø–µ—Ä
async function api(url, method = 'GET', body = null) {
    const options = { method, headers: { 'Content-Type': 'application/json' } };
    if (body) options.body = JSON.stringify(body);

    const response = await fetch(url, options);
    if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞: ${response.status}`);
    return response.json();
}

// –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–∏—Å—à–∏—Ö backdrop
function cleanupModals() {
    document.body.classList.remove('modal-open');
    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ —ç–º–æ—Ü–∏–π
function openEmotionModal(date) {
    window.selectedDate = date;
    const modal = new bootstrap.Modal(document.getElementById('emotionModal'));
    modal.show();
}

// –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–º–æ—Ü–∏–∏
async function quickAddEmotion(date, emotion) {
    try {
        const data = await api('/calendar/save-emotion', 'POST', {
            date,
            emotion,
            note: ''
        });

        if (data.success) {
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —ç–º–æ—Ü–∏–∏');
        }
    } catch (err) {
        console.error(err);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
    }
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –¥–µ—Ç–∞–ª–µ–π –¥–Ω—è
function openDayDetails(date) {
    window.selectedDate = date;

    const modal = new bootstrap.Modal(document.getElementById('dayDetailsModal'));
    const modalLabel = document.getElementById('dayDetailsModalLabel');
    const modalContent = document.getElementById('dayDetailsContent');
    const createNoteBtn = document.getElementById('createNoteBtn');

    modalLabel.textContent = `–î–µ—Ç–∞–ª–∏ –¥–Ω—è: ${new Date(date).toLocaleDateString('ru-RU')}`;
    createNoteBtn.href = `/notes/create?date=${date}`;

    fetch(`/calendar/day-details?date=${date}`)
        .then(r => r.text())
        .then(html => modalContent.innerHTML = html)
        .catch(() => modalContent.innerHTML = '<p class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>');

    modal.show();
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —ç–º–æ—Ü–∏–∏
async function saveEmotion() {
    if (!window.selectedEmotion) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ—Ü–∏—é');
        return;
    }

    try {
        const note = document.getElementById('emotionNote').value;

        const data = await api('/calendar/save-emotion', 'POST', {
            date: window.selectedDate,
            emotion: window.selectedEmotion,
            note
        });

        if (data.success) {
            document.getElementById('emotionNote').value = '';
            document.querySelectorAll('.emotion-btn').forEach(b => {
                b.classList.remove('btn-primary');
                b.classList.add('btn-outline-secondary');
            });

            window.selectedEmotion = null;

            cleanupModals();
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + data.message);
        }
    } catch (err) {
        console.error(err);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    const emotionModal = document.getElementById('emotionModal');
    const dayDetailsModal = document.getElementById('dayDetailsModal');

    // –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –¥–Ω–∏
    document.querySelectorAll('.calendar-day').forEach(day => {
        day.addEventListener('click', () => {
            const date = day.dataset.date;
            if (date) openDayDetails(date);
        });
    });

    // –í—ã–±–æ—Ä —ç–º–æ—Ü–∏–∏
    document.querySelectorAll('.emotion-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.emotion-btn').forEach(b => {
                b.classList.remove('btn-primary');
                b.classList.add('btn-outline-secondary');
            });

            this.classList.remove('btn-outline-secondary');
            this.classList.add('btn-primary');

            window.selectedEmotion = this.dataset.emotion;
        });
    });

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —ç–º–æ—Ü–∏–∏
    document.getElementById('saveEmotion').addEventListener('click', saveEmotion);

    // –û—á–∏—Å—Ç–∫–∞ backdrop –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
    emotionModal.addEventListener('hidden.bs.modal', cleanupModals);
    dayDetailsModal.addEventListener('hidden.bs.modal', cleanupModals);
});
</script>


<div class="page-bottom-spacer" style="height: 100px;"></div>


