@{
    ViewData["Title"] = "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ç–µ—Å—Ç–æ–≤";
    var tests = ViewBag.Tests as IEnumerable<Sofia.Web.Models.Test> ?? Enumerable.Empty<Sofia.Web.Models.Test>();
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ç–µ—Å—Ç–æ–≤</h2>
    <div class="d-flex gap-2 align-items-center">
        <a href="/tests" class="btn btn-outline-secondary btn-sm">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</a>
    </div>
</div>

<div class="row mb-3 g-2">
    <div class="col-md-4">
        <label class="form-label">–¢–µ—Å—Ç</label>
        <select id="testSelect" class="form-select">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç</option>
            @foreach (var t in tests)
            {
                <option value="@t.Id">@t.Name</option>
            }
        </select>
    </div>
    <div class="col-md-3">
        <label class="form-label">–ü–µ—Ä–∏–æ–¥ —Å</label>
        <input type="date" id="fromDate" class="form-control" />
    </div>
    <div class="col-md-3">
        <label class="form-label">–ø–æ</label>
        <input type="date" id="toDate" class="form-control" />
    </div>
    <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-primary w-100" onclick="loadData()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>
</div>

<div class="card mb-3">
    <div class="card-body">
        <canvas id="analyticsChart" width="800" height="300"></canvas>
    </div>
</div>

<div id="interpretation" class="mb-3"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chart = null;
function loadData(){
    const testId = document.getElementById('testSelect').value;
    const from = document.getElementById('fromDate').value;
    const to = document.getElementById('toDate').value;
    if (!testId || !from || !to) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç –∏ –ø–µ—Ä–∏–æ–¥'); return; }

    const fromDT = new Date(from);
    const toDT = new Date(to);
    toDT.setHours(23,59,59,999);

    fetch(`/tests/analytics/data?testId=${testId}&from=${fromDT.toISOString()}&to=${toDT.toISOString()}`)
        .then(r => r.json()).then(j => {
            if (!j.success) { alert(j.message || '–û—à–∏–±–∫–∞'); return; }
            const data = j.data;
            const labels = data.map(d => new Date(d.date).toLocaleDateString());
            const scores = data.map(d => d.score);
            const avg = j.avg;
            const trend = j.trend;

            document.getElementById('interpretation').innerHTML = `<div class="alert alert-info">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª: <strong>${avg.toFixed(1)}</strong>. –¢—Ä–µ–Ω–¥: <strong>${trend}</strong>.</div>`;

            if (chart) chart.destroy();
            const ctx = document.getElementById('analyticsChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ label: '–ë–∞–ª–ª—ã', data: scores, borderColor: 'rgb(75, 192, 192)', tension: 0.2, fill: false }]
                },
                options: { responsive: true }
            });
        });
}
</script>